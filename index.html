<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Love Gun</title>
    <meta http-equiv="Content-Security-Policy" content="img-src 'self' data:; default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
    <button id="play-pause-btn">‚è∏Ô∏è</button>
    <img id="home-button" src="images/home.gif" alt="Home" onclick="goToLinksPage()">

    <audio id="background-music" src="NIGHTCORE Love Gun.mp3" loop></audio>

    <div id="start-game-page">
        <select id="background-select"></select>
        <button onclick="startGame()">Start Game</button>
    </div>

    <button id="play-next-level-btn">Play Next Level</button>
    <button id="restart-button" onclick="restartGame()">Play Again</button>
    <div id="notification"></div>
    <div id="level-progress">
        <div id="level-progress-bar"></div>
    </div>

<script>
    const backgroundMusic = document.getElementById('background-music');
    const playPauseBtn = document.getElementById('play-pause-btn');
    const playNextLevelBtn = document.getElementById("play-next-level-btn");
    let emojiIntervals = [];
    let level = 1;
    let baseSpeed = 1;
    let totalScore = 0;
    let gameTimer;
    let timerInterval;
    let levelScores = [];

    const emojis = ['üòπ', 'üåΩ', 'ü§°', 'üçä', 'üíâüß¨', 'üáπüáº', 'üê∂üî´', 'üåé‚òÆÔ∏è', 'ü•©', 'üê∏', 'üî•', 'üé≤', 'üôÇ‚õìÔ∏è', 'üá∫üá∏', 'ü•®', 'üî®', 'üçÜ', 'üç£', 'ü™≤üßÉ', 'üß†ü§è ', 'üê°', 'üí∏', 'üê∑', 'üê§', 'üåï', 'ü™®', '‚úÇÔ∏è', 'üìÑ', '‚úâÔ∏è', 'ü¶ê', 'üá®üá≥', ' ‡§ú‡•Ä‡§§', 'ü•ß', 'üåÆ', 'üí©', 'üëΩ', 'üçâ', 'üçë', 'üöÄ', 'üíÄ'];

    function loadBackgroundOptions() {
        const backgrounds = [
            { name: 'Default (Pink)', url: '' },
            { name: 'Background 1', url: 'images/bg1.png' },
            { name: 'Background 2', url: 'images/bg2.png' },
            { name: 'Background 3', url: 'images/bg3.png' },
            { name: 'Background 4', url: 'images/bg4.png' },
            { name: 'Background 5', url: 'images/bg5.png' },
            { name: 'Background 6', url: 'images/bg6.png' },
            { name: 'Background 7', url: 'images/bg7.png' },
            { name: 'Background 8', url: 'images/bg8.png' },
            { name: 'Background 9', url: 'images/bg9.png' },
            { name: 'Background 10', url: 'images/bg10.png' },
            { name: 'Animated Background 1', url: 'images/animated_bg1.gif' },
            { name: 'Animated Background 2', url: 'images/animated_bg2.gif' },
            { name: 'Animated Background 3', url: 'images/animated_bg3.gif' }
        ];

        const selectBackground = document.getElementById('background-select');
        backgrounds.forEach((bg, index) => {
            const option = document.createElement('option');
            option.value = bg.url;
            option.textContent = bg.name;
            selectBackground.appendChild(option);
        });

        selectBackground.addEventListener('change', function() {
            updateBackground(this.value);
        });
    }

    function updateBackground(imageUrl) {
        console.log('Updating background with:', imageUrl);
        if (imageUrl) {
            document.body.style.backgroundImage = `url('${imageUrl}')`;
        } else {
            document.body.style.backgroundImage = 'none';
            document.body.style.backgroundColor = '#ff69b4'; // Pink background
        }
    }

    function updateScoreDisplay() {
        const paddedScore = totalScore.toString().padStart(3, '0');
        const scoreElement = document.getElementById('score');
        if (scoreElement) {
            scoreElement.textContent = `Score: ${paddedScore}`;
        }
    }

    function updateLevelDisplay() {
        const levelElement = document.getElementById('level');
        if (levelElement) {
            levelElement.textContent = `Level: ${level}`;
        }
    }

    function updateLevelProgress(percentage) {
        const progressBar = document.getElementById('level-progress-bar');
        if (progressBar) {
            progressBar.style.width = `${percentage}%`;
        }
    }

    function updateTimerDisplay(timeLeft) {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        const timerElement = document.getElementById('timer');
        if (timerElement) {
            timerElement.textContent = `Time: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
    }

    function showNotification(message) {
        const notification = document.getElementById('notification');
        const nextLevelBtn = document.getElementById('play-next-level-btn');
        const restartButton = document.getElementById('restart-button');
        
        notification.textContent = message;
        notification.style.display = 'block';
        
        if (nextLevelBtn.style.display !== 'none') {
            const btnRect = nextLevelBtn.getBoundingClientRect();
            notification.style.bottom = `${window.innerHeight - btnRect.top + 20}px`;
        } else if (restartButton.style.display !== 'none') {
            const btnRect = restartButton.getBoundingClientRect();
            notification.style.bottom = `${window.innerHeight - btnRect.top + 20}px`;
        } else {
            notification.style.bottom = '50%';
        }
        
        console.log("Showing notification:", message);
    }

    function hideNotification() {
        const notification = document.getElementById('notification');
        notification.style.display = 'none';
    }

    function startGame() {
        const selectedBackground = document.getElementById('background-select').value;
        document.getElementById('start-game-page').style.display = 'none';
        backgroundMusic.currentTime = 0;
        backgroundMusic.play();
        updateBackground(selectedBackground);
        initializeGame();
    }

    function initializeGame() {
        setupGameElements();
        emojiIntervals = [];
        updateScoreDisplay();
        updateLevelDisplay();
        updateLevelProgress(0);
        startFallingEmojis();
        document.addEventListener('mousemove', moveGun);
        document.addEventListener('click', shootEmoji);
        backgroundMusic.currentTime = 0;
        backgroundMusic.play();
    }

    function setupGameElements() {
        const existingGun = document.querySelector('.gun');
        if (existingGun) {
            existingGun.remove();
        }

        ['score', 'level', 'timer'].forEach(id => {
            if (!document.getElementById(id)) {
                const element = document.createElement('div');
                element.id = id;
                document.body.appendChild(element);
            }
        });

        const gun = document.createElement('div');
        gun.className = 'gun';
        gun.textContent = '‚ñÑÔ∏ª„Éá‚ïê‚ïê‚Äê‰∏Ä';
        document.body.appendChild(gun);

        const gameArea = document.getElementById('game') || document.createElement('div');
        if (!gameArea.id) {
            gameArea.id = 'game';
            document.body.appendChild(gameArea);
        } else {
            gameArea.innerHTML = '';
        }

        document.getElementById('play-next-level-btn').style.display = 'none';
        document.getElementById('restart-button').style.display = 'none';
    }

    function createFallingEmoji() {
        const gameArea = document.getElementById('game');
        const emoji = document.createElement('div');
        emoji.classList.add('falling-emoji');
        emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        
        const column = Math.floor(Math.random() * 10);
        const leftPosition = column * 10 + Math.random() * 5;
        emoji.style.left = `${leftPosition}%`;
        
        gameArea.appendChild(emoji);

        const fallDuration = 6000 / baseSpeed;
        emoji.style.animation = `fall ${fallDuration}ms linear`;

        const emojiInterval = setTimeout(() => {
            if (emoji.parentNode) {
                gameArea.removeChild(emoji);
            }
        }, fallDuration);

        emojiIntervals.push(emojiInterval);
    }

    function startFallingEmojis() {
        function createEmoji() {
            createFallingEmoji();
            const nextInterval = Math.random() * 800 + 400;
            emojiIntervals.push(setTimeout(createEmoji, nextInterval));
        }
        createEmoji();

        let timeLeft = 150;
        updateTimerDisplay(timeLeft);
        
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay(timeLeft);
            updateLevelProgress((150 - timeLeft) / 150 * 100);
            if (timeLeft <= 0) {
                stopGame();
            }
        }, 1000);

        gameTimer = setTimeout(stopGame, 150000);
    }

    function shootEmoji(event) {
        const emoji = document.elementFromPoint(event.clientX, event.clientY);
        const gameArea = document.getElementById('game');

        if (emoji && emoji.classList.contains('falling-emoji')) {
            const rect = emoji.getBoundingClientRect();
            const heart = document.createElement('div');
            heart.classList.add('heart');
            heart.textContent = '‚ô°';
            heart.style.left = `${rect.left}px`;
            heart.style.top = `${rect.top}px`;
            gameArea.appendChild(heart);

            emoji.remove();
            totalScore++;
            updateScoreDisplay();

            setTimeout(() => {
                if (heart.parentNode) {
                    gameArea.removeChild(heart);
                }
            }, 1000);
        }
    }

    function moveGun(event) {
        const gun = document.querySelector('.gun');
        if (gun) {
            const angle = getAngle(event.clientX, event.clientY, gun);
            gun.style.transform = `translateX(-50%) rotate(${angle}deg)`;
        }
    }

    function getAngle(mouseX, mouseY, gun) {
        const rect = gun.getBoundingClientRect();
        const gunX = rect.left + rect.width / 2;
        const gunY = rect.top + rect.height / 2;
        const angle = Math.atan2(mouseY - gunY, mouseX - gunX) * (180 / Math.PI);
        return angle;
    }

    function stopGame() {
        console.log("Stopping game and calling endLevel");
        clearTimeout(gameTimer);
        clearInterval(timerInterval);
        emojiIntervals.forEach(interval => clearTimeout(interval));
        emojiIntervals = [];
        backgroundMusic.pause();
        document.removeEventListener('mousemove', moveGun);
        document.removeEventListener('click', shootEmoji);
        setTimeout(endLevel, 100);
    }

    function endLevel() {
        console.log("endLevel function called");
        levelScores.push(totalScore);
        const currentLevelScore = totalScore - (levelScores.length > 1 ? levelScores[levelScores.length - 2] : 0);
        
        const gameArea = document.getElementById('game');
        if (gameArea) {
            gameArea.innerHTML = '';
        }

        if (level < 10) {
            const playNextLevelBtn = document.getElementById('play-next-level-btn');
            if (playNextLevelBtn) {
                playNextLevelBtn.style.display = 'block';
                setTimeout(() => {
                    showNotification(`ü¶Ñ ùì∏ùì∂ùì∞ ùîÄùì∏ùîÄ! ùìæùìª ùìµùì∏ùìøùìÆ ùì∞ùìæùì∑ùì∑ùìÆùì≠ ùì≠ùì∏ùîÄùì∑ ${currentLevelScore} ùì∂ùìÆùì∂ùì∏ùì≥ùì≤ùìº ùì§ùîÄùì§! ü¶Ñ`);
                }, 10);
            }
        } else {
            endGame();
        }
    }

    function endGame() {
        console.log("End game function called");
        const restartButton = document.getElementById('restart-button');
        restartButton.style.display = 'block';

        setTimeout(() => {
            showNotification(`Game Over! FINAL SCORE: ${totalScore} UwU!`);
        }, 10);

        baseSpeed *= 1.2;
    }

    playPauseBtn.addEventListener('click', function() {
        if (backgroundMusic.paused) {
            backgroundMusic.play();
            playPauseBtn.textContent = '‚è∏Ô∏è';
        } else {
            backgroundMusic.pause();
            playPauseBtn.textContent = '‚ñ∂Ô∏è';
        }
    });

    playNextLevelBtn.addEventListener('click', () => {
        console.log("Next level button clicked");
        playNextLevelBtn.style.display = 'none';
        hideNotification();
        level++;
        baseSpeed *= 1.1;
        showNotification(`Get ready for Level ${level}!`);
        setTimeout(() => {
            hideNotification();
            initializeGame();
        }, 2000);
    });

    function restartGame() {
        console.log("Restart game function called");
        document.getElementById('restart-button').style.display = 'none';
        hideNotification();
        totalScore = 0;
        level = 1;
        baseSpeed = 1;
        levelScores = [];
        initializeGame();
    }

    function goToLinksPage() {
        window.location.href = 'https://lovegun.xyz';
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadBackgroundOptions();
    });
</script>
</body>
</html>
