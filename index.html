<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Love Gun</title>
    <style>
        /* ... (previous styles remain unchanged) ... */
    </style>
</head>
<body>
    <!-- ... (previous HTML structure remains unchanged) ... -->

    <script>
        // ... (previous variable declarations remain unchanged) ...
        let gameTimeout;
        let emojiCreationTimeout;

        // ... (previous functions remain unchanged) ...

        function stopGame() {
            clearTimeout(gameTimeout);
            clearTimeout(emojiCreationTimeout);
            clearInterval(timerInterval);
            emojiIntervals.forEach(interval => clearTimeout(interval));
            emojiIntervals = [];
            backgroundMusic.pause();
            backgroundMusic.currentTime = 0;
            document.removeEventListener('mousemove', moveGun);
            document.removeEventListener('click', shootEmoji);
            endLevel();
        }

        function initializeGame() {
            // ... (previous initialization code remains unchanged) ...

            function createFallingEmoji() {
                const emoji = document.createElement('div');
                emoji.classList.add('falling-emoji');
                emoji.textContent = currentLevelEmojis[Math.floor(Math.random() * currentLevelEmojis.length)];
                
                // Ensure even distribution across the width
                const column = Math.floor(Math.random() * 10); // 10 columns
                const leftPosition = column * 10 + Math.random() * 5; // Add small random offset within column
                emoji.style.left = `${leftPosition}%`;
                
                gameArea.appendChild(emoji);

                const fallDuration = 6000 / baseSpeed;
                emoji.style.animation = `fall ${fallDuration}ms linear`;

                const emojiInterval = setTimeout(() => {
                    if (emoji.parentNode) {
                        gameArea.removeChild(emoji);
                        combo = 1; // Reset combo when an emoji is missed
                        updateComboDisplay();
                    }
                }, fallDuration);

                emojiIntervals.push(emojiInterval);

                emojiCreationTimeout = setTimeout(createFallingEmoji, Math.random() * 800 + 400);
            }

            // ... (rest of the initializeGame function remains unchanged) ...

            function startFallingEmojis() {
                createFallingEmoji();

                let timeLeft = 150; // 2.5 minutes in seconds
                updateTimerDisplay(timeLeft);
                
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay(timeLeft);
                    if (timeLeft <= 0) {
                        stopGame();
                    }
                }, 1000);

                // Set a timeout to stop the game after exactly 2.5 minutes
                gameTimeout = setTimeout(stopGame, 150000); // 2.5 minutes in milliseconds
            }

            document.addEventListener('mousemove', moveGun);
            document.addEventListener('click', shootEmoji);
            startFallingEmojis();
        }

        function endLevel() {
            showNotification(`Wow! Your love gunned down ${totalScore} points so far!`);

            if (level < 10) {
                setTimeout(() => {
                    playNextLevelBtn.style.display = 'block';
                }, 3000);
            } else {
                setTimeout(endGame, 3000);
            }
        }

        function endGame() {
            showNotification(`Game Over! Your final score is ${totalScore}!\nHigh Score: ${highScore}`);
            setTimeout(() => {
                const gameArea = document.getElementById('game');
                if (gameArea) {
                    gameArea.innerHTML = '';
                }
                document.getElementById('restart-button').style.display = 'block';
            }, 3000);
        }

        playNextLevelBtn.addEventListener('click', () => {
            playNextLevelBtn.style.display = 'none';
            level++;
            baseSpeed *= 1.1; // Increase speed by 10% per level
            backgroundMusic.currentTime = 0; // Restart the song
            initializeGame();
        });

        function restartGame() {
            document.getElementById('restart-button').style.display = 'none';
            totalScore = 0;
            level = 1;
            baseSpeed = 1;
            initializeGame();
        }

        // ... (rest of the code remains unchanged) ...
    </script>
</body>
</html>
